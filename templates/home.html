{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4"><i class="bi bi-calendar-check"></i> ä»Šæ—¥ã®ç¿’æ…£ãƒã‚§ãƒƒã‚¯</h2>

  <form method="get" class="mb-4">
    <label for="date-input">è¡¨ç¤ºã™ã‚‹æ—¥ä»˜ï¼š</label>
    <input type="date" id="date-input" name="date" value="{{ selected_date|date:'Y-m-d' }}">
    <button type="submit" class="btn btn-outline-primary">è¡¨ç¤º</button>
  </form>

  <p><strong>è¡¨ç¤ºä¸­ã®æ—¥ä»˜ï¼š</strong>{{ selected_date|date:"Yå¹´næœˆjæ—¥" }}</p>

  {% for goal, habits in goal_habit_map.items %}
    <!-- ğŸ¯ ç›®æ¨™ãƒœã‚¿ãƒ³ -->
    <button class="btn btn-outline-dark mb-2 toggle-habits w-100 text-start" data-goal-id="{{ goal.id }}">
      <i class="fas {{ goal.icon }}"></i> {{ goal.goal_name }}
    </button>

    <!-- âœ… ç¿’æ…£ãƒªã‚¹ãƒˆï¼šåˆæœŸã¯éè¡¨ç¤º -->
    <div id="habit-group-{{ goal.id }}" class="ps-3 mb-4 d-none">
      {% if habits %}
        <ul class="list-unstyled">
          {% for habit_info in habits %}
            {% with habit=habit_info.habit count=habit_info.done_count %}
              <li class="mb-3">
                <strong><i class="fas {{ habit.icon }}"></i> {{ habit.habit_name }}</strong><br>
                <small class="text-muted">
                  å®Ÿè¡Œå›æ•°: {{ habit.target_value }}{{ habit.target_unit }}ï¼ˆ{{ habit.target_frequency }}ï¼‰<br>
                  æ›œæ—¥: {{ habit.schedule_days }}
                </small><br>

                <!-- é”æˆãƒœã‚¿ãƒ³ -->
                <button class="btn btn-sm toggle-btn {% if log_map|dict_get:habit.id %}btn-success{% else %}btn-outline-secondary{% endif %}"
                        data-habit-id="{{ habit.id }}"
                        data-selected-date="{{ selected_date }}">
                  {% if log_map|dict_get:habit.id %}
                    âœ… é”æˆ
                  {% else %}
                    âŒ æœªé”æˆ
                  {% endif %}
                </button>

                <!-- ã‚³ãƒ¡ãƒ³ãƒˆãƒœã‚¿ãƒ³ -->
                <button class="btn btn-sm btn-link text-decoration-none comment-btn" data-habit-id="{{ habit.id }}">
                  âœï¸ ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›¸ã
                </button>

                <!-- ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="comment-form mt-2 d-none" id="comment-form-{{ habit.id }}">
                  <textarea class="form-control mb-2" rows="2"
                            placeholder="ç¿’æ…£ã¸ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
                  <button class="btn btn-sm btn-primary submit-comment-btn" data-habit-id="{{ habit.id }}">
                    ã‚³ãƒ¡ãƒ³ãƒˆä¿å­˜
                  </button>
                </div>
              </li>
            {% endwith %}
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">ã“ã®ç›®æ¨™ã«ã¯ç¿’æ…£ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      {% endif %}
    </div>
  {% endfor %}

  <hr>

  <h4><i class="bi bi-journal-text"></i> ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒ¢</h4>
  <form method="post" action="{% url 'save_summary_note' %}" class="mt-2">
    {% csrf_token %}
    <input type="hidden" name="date" value="{{ selected_date|date:'Y-m-d' }}">
    <textarea name="note" class="form-control mb-2" rows="3"
              placeholder="ä»Šæ—¥1æ—¥ã®æ„Ÿæƒ³ãƒ»æ°—ã¥ããƒ»åçœãªã©ã‚’è¨˜éŒ²...">{% if daily_report %}{{ daily_report.note }}{% endif %}</textarea>
    <button type="submit" class="btn btn-primary">ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
  </form>

  {% if daily_report and daily_report.note %}
    <div class="alert alert-info mt-4">
      <strong>{{ selected_date|date:"Yå¹´mæœˆdæ—¥" }} ã®æŒ¯ã‚Šè¿”ã‚Šï¼š</strong><br>
      {{ daily_report.note|linebreaksbr }}
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
    console.log("ğŸ“¦ toggle-habits buttons:", document.querySelectorAll(".toggle-habits"));

    document.querySelectorAll(".toggle-habits").forEach(button => {
      button.addEventListener("click", function () {
        const goalId = this.dataset.goalId;
        const habitGroup = document.getElementById(`habit-group-${goalId}`);
        console.log("ğŸ¯ clicked goalId:", goalId, habitGroup);
        if (habitGroup) {
          habitGroup.classList.toggle("d-none");
        } else {
          alert(`â›” è¡¨ç¤ºå¯¾è±¡ã®habit-group-${goalId}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
        }
      });
    });
  

  // âœ… ç¿’æ…£ã®é”æˆãƒˆã‚°ãƒ«
  document.querySelectorAll(".toggle-btn").forEach(button => {
    button.addEventListener("click", function () {
      const habitId = this.dataset.habitId;
      const selectedDate = document.getElementById("date-input").value;

      fetch("/habits/toggle/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: `habit_id=${habitId}&date=${selectedDate}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          this.innerHTML = data.completed ? "âœ… é”æˆ" : "âŒ æœªé”æˆ";
          this.classList.toggle("btn-success", data.completed);
          this.classList.toggle("btn-outline-secondary", !data.completed);
        }
      });
    });
  });

  // âœ… ã‚³ãƒ¡ãƒ³ãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ‡æ›¿
  document.querySelectorAll(".comment-btn").forEach(button => {
    button.addEventListener("click", function () {
      const habitId = this.dataset.habitId;
      const form = document.getElementById(`comment-form-${habitId}`);
      form.classList.toggle("d-none");
    });
  });

  // âœ… ã‚³ãƒ¡ãƒ³ãƒˆä¿å­˜å‡¦ç†
  document.querySelectorAll(".submit-comment-btn").forEach(button => {
    button.addEventListener("click", function () {
      const habitId = this.dataset.habitId;
      const form = document.getElementById(`comment-form-${habitId}`);
      const textarea = form.querySelector("textarea");
      const comment = textarea.value;
      const selectedDate = document.getElementById("date-input").value;

      fetch("{% url 'save_comment' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: new URLSearchParams({
          habit_id: habitId,
          comment: comment,
          date: selectedDate,
        }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("ã‚³ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
          form.classList.add("d-none");
        } else {
          alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + data.message);
        }
      })
      .catch(error => {
        alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
        console.error("Error:", error);
      });
    });
  });
});
</script>
{% endblock %}
