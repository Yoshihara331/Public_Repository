{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}
{% load custom_filters %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4"><i class="bi bi-calendar-check"></i> ä»Šæ—¥ã®ç¿’æ…£ãƒã‚§ãƒƒã‚¯</h2>

  <form method="get" class="mb-4">
    <label for="date-input">è¡¨ç¤ºã™ã‚‹æ—¥ä»˜ï¼š</label>
    <input type="date" id="date-input" name="date" value="{{ selected_date|date:'Y-m-d' }}">
    <button type="submit" class="btn btn-outline-primary">è¡¨ç¤º</button>
  </form>

  <p><strong>è¡¨ç¤ºä¸­ã®æ—¥ä»˜ï¼š</strong>{{ selected_date|date:"Yå¹´næœˆjæ—¥" }}</p>

  {% for goal, habits in goal_habit_map.items %}
    <div class="card mb-3">
      <div class="card-header">
        {% if goal %}
          <strong><i class="fas {{ goal.icon }}"></i> {{ goal.title }}</strong>
        {% else %}
          <strong>ğŸ“‚ ãã®ä»–ã®ç¿’æ…£</strong>
        {% endif %}

        {% if not habits %}
          <span class="text-muted ms-2">
            {% if goal %}
              {% if today_weekday_in_goal_days|get_item:goal.id %}
                ï¼ˆã“ã®ç›®æ¨™ã«ã¯ç¿’æ…£ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ï¼‰
              {% else %}
                ï¼ˆæœ¬æ—¥ã®ç¿’æ…£ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰
              {% endif %}
            {% else %}
              ï¼ˆã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰
            {% endif %}
          </span>
        {% endif %}
      </div>

      {% if habits %}
      <div class="card-body">
        <ul class="list-unstyled">
          {% for habit_info in habits %}
            {% with habit=habit_info.habit count=habit_info.done_count %}
            <li class="mb-3">
              <strong>
                {% if habit.goal %}<i class="fas {{ habit.goal.icon }}"></i>{% endif %} {{ habit.habit_name }}
              </strong><br>
              <small class="text-muted">
                å®Ÿè¡Œå›æ•°: {{ habit.target_value }}{{ habit.target_unit }}ï¼ˆ{{ habit.target_frequency }}ï¼‰<br>
                æ›œæ—¥: {{ habit.schedule_days|replace_commas_with_dot }}<br>
                é€šç®—é”æˆæ•°: {{ count }}å›
              </small><br>
              <button class="btn btn-sm toggle-btn {% if log_map|get_item:habit.id %}btn-success{% else %}btn-outline-secondary{% endif %}"
                      data-habit-id="{{ habit.id }}"
                      data-selected-date="{{ selected_date }}"
                      {% if selected_date|date:'Ymd' > today|date:'Ymd' %}disabled{% endif %}>
                {% if log_map|get_item:habit.id %}
                  âœ… é”æˆ
                {% else %}
                  âŒ æœªé”æˆ
                {% endif %}
              </button>
            </li>
            {% endwith %}
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    </div>
  {% endfor %}

  <hr>
  <h4><i class="bi bi-journal-text"></i> ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒ¢</h4>
  <form method="post" action="{% url 'save_summary_note' %}" class="mt-2">
    {% csrf_token %}
    <input type="hidden" name="date" value="{{ selected_date|date:'Y-m-d' }}">
    <textarea name="note" class="form-control mb-2" rows="3"
              placeholder="ä»Šæ—¥1æ—¥ã®æ„Ÿæƒ³ãƒ»æ°—ã¥ããƒ»åçœãªã©ã‚’è¨˜éŒ²..." {% if selected_date > today %}disabled{% endif %}>{% if daily_report %}{{ daily_report.note }}{% endif %}</textarea>
    <button type="submit" class="btn btn-primary" {% if selected_date > today %}disabled{% endif %}>ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
  </form>

  {% if daily_report and daily_report.note %}
    <div class="alert alert-info mt-4">
      <strong>{{ selected_date|date:"Yå¹´mæœˆdæ—¥" }} ã®æŒ¯ã‚Šè¿”ã‚Šï¼š</strong><br>
      {{ daily_report.note|linebreaksbr }}
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".toggle-btn").forEach(button => {
    button.addEventListener("click", function () {
      if (this.disabled) return;

      const habitId = this.dataset.habitId;
      const selectedDate = document.getElementById("date-input").value;

      fetch("/habits/toggle/", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: `habit_id=${habitId}&date=${selectedDate}`
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          this.innerHTML = data.completed ? "âœ… é”æˆ" : "âŒ æœªé”æˆ";
          this.classList.toggle("btn-success", data.completed);
          this.classList.toggle("btn-outline-secondary", !data.completed);
        } else {
          console.warn("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:", data.message);
        }
      })
      .catch(error => console.error("fetché€šä¿¡ã‚¨ãƒ©ãƒ¼:", error));
    });
  });
});
</script>
{% endblock %}
