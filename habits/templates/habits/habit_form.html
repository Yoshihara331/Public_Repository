{% extends "base.html" %}
{% load custom_filters %}
{% block title %}ç¿’æ…£ä½œæˆãƒ»ç·¨é›†{% endblock %}

{% block content %}
<h2>{% if form.instance.pk %}ç¿’æ…£ç·¨é›†{% else %}ç¿’æ…£ä½œæˆ{% endif %}</h2>

<form method="POST" onsubmit="return validateAndConfirm(event);">
  {% csrf_token %}

  <!-- ç¿’æ…£å -->
  <div class="mb-3">
    <label for="{{ form.habit_name.id_for_label }}" class="form-label">ç¿’æ…£å</label>
    {{ form.habit_name }}
    {% for error in form.habit_name.errors %}
      <div class="text-danger small">{{ error }}</div>
    {% endfor %}
  </div>

  <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆç›®æ¨™ï¼‰ -->
  <div class="mb-3">
    <label for="{{ form.goal.id_for_label }}" class="form-label">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
    <select name="goal" id="id_goal" class="form-select">
      <option value="">-- ã‚«ãƒ†ã‚´ãƒªãƒ¼ãªã— --</option>
      {% for goal in form.fields.goal.queryset %}
        <option value="{{ goal.id }}" data-icon="{{ goal.icon }}"
          {% if form.initial.goal and form.initial.goal == goal.id or form.instance.goal and form.instance.goal.id == goal.id %}selected{% endif %}>
          {{ goal.title }}
        </option>
      {% endfor %}
    </select>
    {% for error in form.goal.errors %}
      <div class="text-danger small">{{ error }}</div>
    {% endfor %}
  </div>

  <!-- ğŸ¯ ç›®æ¨™ -->
  <div class="mb-3">
    <label class="form-label">ç›®æ¨™</label>
    <div class="d-flex gap-2 flex-wrap">
      <div>{{ form.target_value }}</div>
      <div>{{ form.target_unit }}</div>
      <div>{{ form.target_frequency }}</div>
    </div>
    {% for error in form.target_value.errors %}
      <div class="text-danger small">{{ error }}</div>
    {% endfor %}
    {% for error in form.target_unit.errors %}
      <div class="text-danger small">{{ error }}</div>
    {% endfor %}
    {% for error in form.target_frequency.errors %}
      <div class="text-danger small">{{ error }}</div>
    {% endfor %}
  </div>

  <!-- ğŸ—“ï¸ å®Ÿæ–½æ›œæ—¥ -->
  <div class="mb-3">
    <label class="form-label">å®Ÿæ–½æ›œæ—¥</label>
    <button type="button" id="select-all" class="btn btn-outline-success btn-sm ms-2">å…¨é¸æŠ</button>
    <button type="button" id="deselect-all" class="btn btn-outline-danger btn-sm ms-2">å…¨è§£é™¤</button>

    <div class="d-flex flex-wrap gap-2 mt-2">
      {% for checkbox in form.schedule_days %}
        <label class="form-check form-check-inline">
          {{ checkbox.tag }} {{ checkbox.choice_label }}
        </label>
      {% endfor %}
    </div>

    {% for error in form.schedule_days.errors %}
      <div class="text-danger small">{{ error }}</div>
    {% endfor %}
  </div>

  <!-- ğŸŒŸ ã‚¢ã‚¤ã‚³ãƒ³ -->
  <div class="mb-3">
    <label for="{{ form.icon.id_for_label }}" class="form-label">ã‚¢ã‚¤ã‚³ãƒ³</label>
    {{ form.icon }}
    {% for error in form.icon.errors %}
      <div class="text-danger small">{{ error }}</div>
    {% endfor %}
  </div>

  <!-- âœ… ä¿å­˜ãƒœã‚¿ãƒ³ -->
  <button type="submit" class="btn btn-primary">ä¿å­˜</button>
  <a href="{% url 'habit_list' %}" class="btn btn-secondary">æˆ»ã‚‹</a>
</form>


<!-- âœ… JavaScript -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const checkboxes = document.querySelectorAll('.schedule-day');

    document.getElementById("select-all").addEventListener("click", () => {
      checkboxes.forEach(cb => cb.checked = true);
    });

    document.getElementById("deselect-all").addEventListener("click", () => {
      checkboxes.forEach(cb => cb.checked = false);
    });

    const goalSelect = document.getElementById("id_goal");
    const iconSelect = document.getElementById("id_icon");
    if (goalSelect && iconSelect) {
      goalSelect.addEventListener("change", function () {
        const selectedOption = this.options[this.selectedIndex];
        const iconValue = selectedOption.getAttribute("data-icon");
        if (iconValue) iconSelect.value = iconValue;
      });
    }
  });

  function validateAndConfirm(event) {
    const form = event.target.closest("form");
    const requiredFields = Array.from(form.querySelectorAll("input[required], select[required], textarea[required]"))
      .filter(field => field.name !== "goal");

    let isValid = true;
    requiredFields.forEach(field => {
      if (!field.value.trim()) isValid = false;
    });

    if (!isValid) {
      alert("æœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚ã™ã¹ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
      event.preventDefault();
      return false;
    }

    return confirm("æœ¬å½“ã«ã“ã®å†…å®¹ã§ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ");
  }
</script>
{% endblock %}
